<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <title>Burbujas de Pr√°ctica por Niveles</title>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --primary-color: #007aff;
            --text-color: #333;
            --text-light-color: #fff;
            --danger-color: #ff3b30;
            --safe-color: #34c759;
            --mastered-color: #ffcc00;
            --card-bg: rgba(255, 255, 255, 0.6);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --blur-amount: 10px;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        #game-wrapper {
            height: 95vh;
            width: 95vw;
            max-width: 1200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #game-container {
            width: 100%;
            height: 100%;
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            position: relative;
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            backdrop-filter: blur(var(--blur-amount));
            -webkit-backdrop-filter: blur(var(--blur-amount));
            overflow: hidden;
            display: flex;
        }
        
        /* --- PANEL DE PROGRESO Y CONTROLES --- */
        #progress-panel {
            width: 300px;
            flex-shrink: 0;
            background: rgba(0,0,0,0.05);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #progress-panel h3 {
            margin: 0 0 15px 0;
            text-align: center;
            color: var(--primary-color);
        }
        #progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
            flex-grow: 1;
        }
        .progress-item {
            background: #fff; border-radius: 8px; padding: 8px;
            text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .progress-number { font-size: 1.5rem; font-weight: 700; }
        .dots { display: flex; justify-content: center; gap: 4px; margin-top: 5px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background-color: #ddd; }
        .dot.p1 { background-color: var(--primary-color); }
        .dot.p2 { background-color: var(--mastered-color); }

        .speed-slider-container {
            margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.1);
        }
        .speed-slider-container label { display: block; margin-bottom: 10px; font-weight: 600; text-align: center;}
        .speed-slider-container .slider-wrapper { display: flex; align-items: center; gap: 10px; }
        #speed-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #ddd; border-radius: 5px; outline: none; }
        #speed-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: var(--primary-color); border-radius: 50%; cursor: pointer; }
        #speed-slider::-moz-range-thumb { width: 24px; height: 24px; background: var(--primary-color); border-radius: 50%; cursor: pointer; }

        /* --- √ÅREA DE JUEGO (BURBUJAS) --- */
        #bubble-area {
            flex-grow: 1;
            position: relative;
            height: 100%;
        }
        .numero { 
            position: absolute; font-weight: 700; color: var(--text-color); 
            background: linear-gradient(145deg, rgba(255,255,255,0.9), rgba(255,255,255,0.6));
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.1); transition: transform 0.3s ease; 
            border: 1px solid rgba(255,255,255,0.8);
        }
        .numero.exploding { animation: explode 0.5s forwards; }
        @keyframes explode { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        #ui-bar {
            position: absolute; bottom: 0; left: 300px; right: 0;
            padding: 15px; box-sizing: border-box; display: flex; flex-direction: column;
            justify-content: center; align-items: center; gap: 10px;
        }
        #live-transcript {
            height: 30px; font-size: 1.5rem; font-weight: 600; color: var(--primary-color);
            opacity: 0.9; text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            transition: opacity 0.5s; text-align: center;
        }
        #voice-input-button {
            width: 70px; height: 70px; flex-shrink: 0; border-radius: 50%; border: none;
            background-color: var(--primary-color); color: white; font-size: 2.5rem;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3); transition: background-color 0.3s;
        }
        #voice-input-button.listening { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0,122,255,0.7); } 70% { box-shadow: 0 0 0 20px rgba(0,122,255,0); } 100% { box-shadow: 0 0 0 0 rgba(0,122,255,0); } }
        
        #info-bar {
            position: absolute; top: 20px; width: 100%; padding: 0 30px;
            box-sizing: border-box; display: flex; justify-content: space-around;
            font-size: 1.8rem; font-weight: 600; color: var(--primary-color);
        }
        .screen {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--card-bg); backdrop-filter: blur(var(--blur-amount));
            color: var(--text-color); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10;
            padding: 30px; text-align: center;
        }
        #start-screen { display: flex; }
        .screen h2 { font-size: 2.5rem; margin-bottom: 15px; }
        .screen p { font-size: 1.2rem; max-width: 500px; margin-bottom: 25px; }
        .screen button, #next-level-button {
            padding: 15px 35px; font-size: 1.1rem; font-family: 'Poppins', sans-serif;
            font-weight: 600; margin-top: 20px; background-color: var(--primary-color);
            color: var(--text-light-color); border: none; border-radius: 50px; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 15px rgba(0,122,255,0.3);
        }
        .screen button:hover, #next-level-button:hover { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(0,122,255,0.4); }
        #next-level-button { background-color: var(--safe-color); box-shadow: 0 4px 15px rgba(52, 199, 89, 0.4); }
        #next-level-button:hover { box-shadow: 0 7px 20px rgba(52, 199, 89, 0.5); }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="progress-panel">
                <h3 id="level-title">Nivel 1</h3>
                <div id="progress-grid"></div>
                
                <div class="speed-slider-container">
                    <label for="speed-slider">Velocidad de Burbujas</label>
                    <div class="slider-wrapper">
                        <span>Lento</span>
                        <input type="range" id="speed-slider" min="1" max="5" value="3">
                        <span>R√°pido</span>
                    </div>
                </div>
            </div>
            <div id="bubble-area">
                 <div id="info-bar">
                    <div id="score">Puntos: 0</div>
                </div>
                <div id="start-screen" class="screen">
                    <h2>Burbujas de Pr√°ctica</h2>
                    <p>Domina los n√∫meros dici√©ndolos en voz alta. <b>¬°Acierta cada n√∫mero 2 veces para avanzar de nivel!</b></p>
                    <button id="start-button">Empezar a Jugar</button>
                </div>
                 <div id="game-complete-screen" class="screen">
                    <h2>¬°Felicidades!</h2>
                    <p>¬°Has completado todos los niveles de pr√°ctica!</p>
                    <button id="restart-game-button">Volver a Empezar</button>
                </div>
                <div id="ui-bar">
                    <div id="live-transcript"></div>
                    <div id="voice-input-button" title="Estado del micr√≥fono">üé§</div>
                    <button id="next-level-button" style="display: none;">Siguiente Nivel</button>
                </div>
            </div>
        </div>
    </div>
<script>
    // --- CONFIGURACI√ìN ---
    const scoreEl = document.getElementById('score');
    const startScreen = document.getElementById('start-screen'), gameCompleteScreen = document.getElementById('game-complete-screen');
    const startButton = document.getElementById('start-button'), restartGameButton = document.getElementById('restart-game-button');
    const voiceInputButton = document.getElementById('voice-input-button');
    const liveTranscriptEl = document.getElementById('live-transcript');
    const progressGrid = document.getElementById('progress-grid');
    const levelTitle = document.getElementById('level-title');
    const nextLevelButton = document.getElementById('next-level-button');
    const bubbleArea = document.getElementById('bubble-area');
    const speedSlider = document.getElementById('speed-slider');

    const popSound = new Audio('https://s3.amazonaws.com/freecodecamp/drums/RP4_KICK_1.mp3');
    popSound.volume = 0.5;

    let score = 0, gameIsRunning = false;
    let numbersOnScreen = [], spawnInterval;
    
    // --- ESTRUCTURA DE NIVELES Y PROGRESO ---
    const gameLevels = [
        { name: "Nivel 1", min: 0, max: 9 },
        { name: "Nivel 2", min: 10, max: 19 },
        { name: "Nivel 3", min: 20, max: 29 },
        { name: "Nivel 4", min: 30, max: 39 }
    ];
    let currentLevelIndex = 0;
    let practiceTracker = {};
    const PRACTICE_GOAL = 2;
    const speedMap = { '1': 0.06, '2': 0.09, '3': 0.12, '4': 0.18, '5': 0.24 };

    let recognition;

    // --- FUNCIONES AUXILIARES ---
    function numberToWords(n){const u=['cero','uno','dos','tres','cuatro','cinco','seis','siete','ocho','nueve'],e=['diez','once','doce','trece','catorce','quince','diecis√©is','diecisiete','dieciocho','diecinueve'],d=['','','veinte','treinta','cuarenta','cincuenta','sesenta','setenta','ochenta','noventa'];if(n>=0&&n<10)return u[n];if(n<20)return e[n-10];if(n<30)return n===20?'veinte':'veinti'+u[n%10];if(n<100){const t=Math.floor(n/10),o=n%10;return d[t]+(o>0?' y '+u[o]:'')}return n.toString()}
    
    // --- FUNCIONES DEL SISTEMA DE PROGRESO ---
    function initializePracticeTracker() {
        practiceTracker = {};
        const level = gameLevels[currentLevelIndex];
        for (let i = level.min; i <= level.max; i++) {
            practiceTracker[i] = 0;
        }
    }

    function updateProgressGrid() {
        const level = gameLevels[currentLevelIndex];
        progressGrid.innerHTML = '';
        levelTitle.textContent = level.name;

        for (let i = level.min; i <= level.max; i++) {
            const count = practiceTracker[i];
            const item = document.createElement('div');
            item.className = 'progress-item';
            
            let dotsHTML = '';
            for (let j = 1; j <= PRACTICE_GOAL; j++) {
                let dotClass = 'dot';
                if (j <= count) dotClass += ` p${j}`;
                dotsHTML += `<span class="${dotClass}"></span>`;
            }

            item.innerHTML = `<span class="progress-number">${i}</span><div class="dots">${dotsHTML}</div>`;
            progressGrid.appendChild(item);
        }
    }

    function checkLevelCompletion() {
        const level = gameLevels[currentLevelIndex];
        for (let i = level.min; i <= level.max; i++) {
            if (practiceTracker[i] < PRACTICE_GOAL) return false;
        }
        return true;
    }

    function levelComplete() {
        gameIsRunning = false;
        if (recognition) { recognition.stop(); }
        clearInterval(spawnInterval);
        liveTranscriptEl.textContent = "¬°Nivel Completado!";
        numbersOnScreen.forEach(num => num.element.remove());
        numbersOnScreen = [];
        nextLevelButton.style.display = 'block';
    }

    // --- L√ìGICA DE RECONOCIMIENTO DE VOZ ---
    function setupSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            voiceInputButton.style.display = 'none';
            liveTranscriptEl.textContent = "Reconocimiento de voz no soportado.";
            return;
        }
        recognition = new SpeechRecognition();
        recognition.lang = 'es-MX';
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.onstart = () => { voiceInputButton.classList.add('listening'); };
        recognition.onresult = (event) => {
            let interim_transcript = '', final_transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) final_transcript += event.results[i][0].transcript;
                else interim_transcript += event.results[i][0].transcript;
            }
            liveTranscriptEl.textContent = interim_transcript;
            if (final_transcript) {
                liveTranscriptEl.textContent = final_transcript;
                const cleaned_transcript = final_transcript.toLowerCase().trim();
                [...numbersOnScreen].forEach(num => {
                    if (num.saved) return;
                    const numAsWord = numberToWords(num.value);
                    if (cleaned_transcript.includes(numAsWord)) saveNumber(num);
                });
                setTimeout(() => { if(gameIsRunning) liveTranscriptEl.textContent = ''; }, 1000);
            }
        };
        recognition.onerror = (event) => console.error("Error en el reconocimiento de voz:", event.error);
        recognition.onend = () => {
            voiceInputButton.classList.remove('listening');
            if (gameIsRunning) recognition.start();
        };
    }

    // --- L√ìGICA PRINCIPAL DEL JUEGO ---
    function startLevel() {
        score = 0;
        updateUI();
        initializePracticeTracker();
        updateProgressGrid();
        
        startScreen.style.display = 'none';
        gameCompleteScreen.style.display = 'none';
        nextLevelButton.style.display = 'none';
        liveTranscriptEl.textContent = '';
        bubbleArea.querySelectorAll('.numero').forEach(n => n.remove());
        
        gameIsRunning = true;
        if (recognition) recognition.start();
        
        spawnInterval = setInterval(spawnNumber, 2500);
    }

    function spawnNumber() {
        if (!gameIsRunning || numbersOnScreen.length >= 4) return;
        
        const level = gameLevels[currentLevelIndex];
        const neededNumbers = [];
        for (let i = level.min; i <= level.max; i++) {
            if (practiceTracker[i] < PRACTICE_GOAL) neededNumbers.push(i);
        }
        if (neededNumbers.length === 0) return;

        const value = neededNumbers[Math.floor(Math.random() * neededNumbers.length)];
        
        const growthRate = speedMap[speedSlider.value];
        const element = document.createElement('div');
        element.classList.add('numero');
        element.textContent = value;
        
        const startSize = 80;
        const numObj = { value, element, size: startSize, startSize, maxSize: 220 + Math.random() * 50, growthRate, saved: false };
        const gameRect = bubbleArea.getBoundingClientRect();
        numObj.x = Math.random() * (gameRect.width - numObj.maxSize - 20) + 10;
        numObj.y = Math.random() * (gameRect.height - numObj.maxSize - 150) + 20;
        element.style.top = `${numObj.y}px`; element.style.left = `${numObj.x}px`;
        numbersOnScreen.push(numObj);
        bubbleArea.appendChild(element);
    }
    function saveNumber(num) {
        if (num.saved) return;
        num.saved = true;
        score += 10;
        updateUI();
        popSound.currentTime = 0;
        popSound.play();
        
        if (practiceTracker[num.value] < PRACTICE_GOAL) {
            practiceTracker[num.value]++;
        }
        updateProgressGrid();
        
        setTimeout(() => {
            if (num.element.parentElement) num.element.remove();
            numbersOnScreen = numbersOnScreen.filter(n => n !== num);
        }, 500);

        if (checkLevelCompletion()) {
            levelComplete();
        }
    }
    function updateUI() { scoreEl.textContent = `Puntos: ${score}`; }

    // --- EVENT LISTENERS ---
    startButton.addEventListener('click', startLevel);
    nextLevelButton.addEventListener('click', () => {
        currentLevelIndex++;
        if (currentLevelIndex >= gameLevels.length) {
            gameCompleteScreen.style.display = 'flex';
        } else {
            startLevel();
        }
    });
    restartGameButton.addEventListener('click', () => {
        currentLevelIndex = 0;
        startLevel();
    });
    // CAMBIO: Event listener para que el slider actualice la velocidad en tiempo real
    speedSlider.addEventListener('input', () => {
        const newGrowthRate = speedMap[speedSlider.value];
        numbersOnScreen.forEach(num => {
            num.growthRate = newGrowthRate;
        });
    });
    document.addEventListener('DOMContentLoaded', () => {
        setupSpeechRecognition();
    });
</script>
</body>
</html>
