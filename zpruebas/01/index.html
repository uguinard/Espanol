<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Agente: Protocolo de Identificación</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Poppins:wght@400;600&display=swap');
        :root {
            --primary-color: #00ffdd; --background-color: #1a232e; --text-color: #e0e0e0;
            --card-background: #2c3a4a; --highlight-color: #ff4757;
        }
        body {
            font-family: 'Poppins', sans-serif; display: flex; justify-content: center; align-items: center;
            height: 100vh; background-color: var(--background-color); color: var(--text-color); margin: 0;
            overflow: hidden;
        }
        #game-container, #identification-screen {
            display: flex; gap: 40px; width: 1300px; height: 800px;
        }
        
        #identification-screen {
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        #identification-screen h1 {
            font-family: 'Roboto Mono', monospace; font-size: 3em; color: var(--primary-color);
        }
        #identification-screen p { font-size: 1.2em; max-width: 600px; line-height: 1.6; }
        #auth-status {
            margin-top: 20px; font-family: 'Roboto Mono', monospace;
            font-size: 1.5em; height: 30px;
        }
        #auth-status.listening { color: #2ecc71; }
        
        #start-auth-btn {
            margin-top: 30px; width: auto; height: 60px; padding: 0 40px; border-radius: 30px; border: none; 
            background-color: var(--primary-color); color: var(--background-color); font-family: 'Poppins', sans-serif;
            font-size: 1.2em; font-weight: 600; cursor: pointer; transition: all 0.2s; 
        }
        #start-auth-btn:disabled { background-color: #555; cursor: not-allowed; }

        #game-container.hidden { display: none; }

        #characters-container { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .character-card { display: flex; align-items: center; padding: 15px; background-color: var(--card-background); border-radius: 10px; border: 2px solid transparent; cursor: pointer; transition: all 0.3s ease; }
        .character-card:hover, .character-card.selected { border-color: var(--primary-color); }
        .character-card.selected { box-shadow: 0 0 15px var(--primary-color); }
        .character-card img { width: 80px; height: 80px; border-radius: 50%; margin-right: 20px; border: 2px solid var(--primary-color); }
        .character-codename { font-size: 1.5em; font-weight: 600; }
        #right-panel { flex: 2; display: flex; flex-direction: column; }
        #dossier-container { flex-grow: 1; background-color: var(--card-background); border-radius: 10px; padding: 25px; }
        #dossier-container h2 { margin-top: 0; text-align: center; font-family: 'Roboto Mono', monospace; color: var(--primary-color); }
        .dossier-entry { margin: 18px 0; font-size: 1.1em; }
        .dossier-label { font-weight: 600; }
        .dossier-field { font-family: 'Roboto Mono', monospace; background-color: #1e2b3a; padding: 10px; border-radius: 5px; display: block; margin-top: 5px; min-height: 22px; color: #fff; }
        .dossier-field.filled { color: var(--primary-color); }
        .dossier-field:not(.filled)::after { content: '_'; animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        #controls { text-align: center; padding-top: 20px; }
        #record-btn { width: auto; height: 60px; padding: 0 40px; border-radius: 30px; border: none; background-color: var(--highlight-color); color: white; font-family: 'Poppins', sans-serif; font-size: 1.2em; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; margin: 0 auto; }
        #record-btn.listening { background-color: #2ecc71; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); } 100% { box-shadow: 0 0 0 20px rgba(46, 204, 113, 0); } }
        #status-text { height: 20px; margin-top: 15px; font-style: italic; }
        #transcript-text { height: 20px; font-family: 'Roboto Mono', monospace;}
    </style>
</head>
<body>

    <div id="identification-screen">
        <h1>[ ACCESO RESTRINGIDO ]</h1>
        <p>Sistema de Interrogatorios de la Agencia. Presiona el botón e identifícate con tu nombre en clave y código de seguridad para proceder.</p>
        <p><strong>Ejemplo:</strong> "Agente especial Coco Perezoso, presente. Código: ka dos, efe ocho, cinco, ka."</p>
        <button id="start-auth-btn">COMENZAR IDENTIFICACIÓN</button>
        <div id="auth-status">Esperando activación...</div>
    </div>

    <div id="game-container" class="hidden">
        <div id="characters-container"></div>
        <div id="right-panel">
            <div id="dossier-container">
                <h2>EXPEDIENTE DEL AGENTE</h2>
                <div class="dossier-entry"><span class="dossier-label">NOMBRE CLAVE:</span><span id="dossier-codename" class="dossier-field"></span></div>
                <div class="dossier-entry"><span class="dossier-label">NOMBRE REAL:</span><span id="dossier-name" class="dossier-field"></span></div>
                <div class="dossier-entry"><span class="dossier-label">EDAD:</span><span id="dossier-age" class="dossier-field"></span></div>
                <div class="dossier-entry"><span class="dossier-label">IDIOMAS:</span><span id="dossier-language" class="dossier-field"></span></div>
                <div class="dossier-entry"><span class="dossier-label">ORIGEN:</span><span id="dossier-origin" class="dossier-field"></span></div>
                <div class="dossier-entry"><span class="dossier-label">RESIDENCIA ACTUAL:</span><span id="dossier-residence" class="dossier-field"></span></div>
            </div>
            <div id="controls">
                <button id="record-btn">Iniciar Interrogatorio</button>
                <p id="status-text">Selecciona un agente para empezar.</p>
                <p id="transcript-text"></p>
            </div>
        </div>
    </div>

    <script>
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("Tu navegador no soporta el reconocimiento de voz. Por favor, usa Google Chrome.");
        }
        
        const CHARACTERS_DATA = {
            'charA': {
                codename: "Agente Alfa", name: "Vanesa", gender: "female", age: 29, language: "Español e inglés",
                origin: "España", residence: "Madrid", img: "https://i.pravatar.cc/150?u=vanesa",
                responses: { name: "Mi nombre real es Vanesa.", age: "Tengo veintinueve años.", language: "Hablo español e inglés con fluidez.", origin: "Soy originaria de España.", residence: "Actualmente vivo en Madrid." }
            },
            'charB': {
                codename: "Agente Beta", name: "Pedro", gender: "male", age: 34, language: "Español y portugués",
                origin: "México", residence: "Ciudad de México", img: "https://i.pravatar.cc/150?u=pedro",
                responses: { name: "Me llamo Pedro, un placer.", age: "Acabo de cumplir treinta y cuatro años.", language: "Domino el español y el portugués.", origin: "Vengo de México.", residence: "Mi residencia está en Ciudad de México." }
            },
            'charC': {
                codename: "Agente Gamma", name: "María", gender: "female", age: 31, language: "Español y francés",
                origin: "Colombia", residence: "Bogotá", img: "https://i.pravatar.cc/150?u=maria",
                responses: { name: "Puedes llamarme María.", age: "Tengo treinta y un años.", language: "Mis idiomas son el español y el francés.", origin: "Soy de Colombia.", residence: "Resido en Bogotá." }
            }
        };
        const KEYWORD_MAP = {
            name: ['nombre', 'llamas', 'llamo', 'quién eres'], age: ['edad', 'años', 'cuántos'], language: ['idioma', 'lengua', 'hablas'],
            origin: ['origen', 'dónde eres', 'vienes', 'país'], residence: ['vives', 'residencia', 'dónde vives']
        };

        const dom = {
            identificationScreen: document.getElementById('identification-screen'), gameContainer: document.getElementById('game-container'),
            authStatus: document.getElementById('auth-status'), startAuthBtn: document.getElementById('start-auth-btn'),
            charactersContainer: document.getElementById('characters-container'), recordBtn: document.getElementById('record-btn'),
            statusText: document.getElementById('status-text'), transcriptText: document.getElementById('transcript-text'),
            dossierFields: {
                codename: document.getElementById('dossier-codename'), name: document.getElementById('dossier-name'), age: document.getElementById('dossier-age'),
                language: document.getElementById('dossier-language'), origin: document.getElementById('dossier-origin'), residence: document.getElementById('dossier-residence')
            }
        };
        
        let gameState = { mode: 'identification', authenticated: false, selectedCharId: null, interviewActive: false };
        let recognition = new SpeechRecognition();
        let voices = [];

        const synth = window.speechSynthesis;
        function loadVoices() { voices = synth.getVoices(); }
        loadVoices();
        if (synth.onvoiceschanged !== undefined) { synth.onvoiceschanged = loadVoices; }

        function speak(text, gender, onEndCallback) {
            if (synth.speaking) synth.cancel();
            const utterThis = new SpeechSynthesisUtterance(text);
            let targetVoice = null;
            if (gender === 'male') {
                targetVoice = voices.find(v => v.lang === 'es-ES' && v.name.includes('Google'));
            } else {
                targetVoice = voices.find(v => v.lang === 'es-US' && v.name.includes('Google'));
            }
            utterThis.voice = targetVoice || voices.find(v => v.lang.startsWith('es-'));
            utterThis.lang = utterThis.voice ? utterThis.voice.lang : 'es-ES';
            if (onEndCallback) utterThis.onend = onEndCallback;
            synth.speak(utterThis);
        }

        function initGame() {
            setupRecognition();
            dom.startAuthBtn.onclick = () => {
                recognition.start();
                dom.startAuthBtn.disabled = true;
                dom.startAuthBtn.textContent = "ESCUCHANDO...";
            };
        }

        function setupRecognition() {
            recognition.lang = 'es-ES';
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onstart = () => {
                if (gameState.mode === 'identification') {
                    dom.authStatus.textContent = "Escuchando... ¡Habla ahora!";
                    dom.authStatus.classList.add('listening');
                }
            };
            
            recognition.onresult = (event) => {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                }
                if (finalTranscript.trim()) {
                    if (gameState.mode === 'identification') {
                        processIdentification(finalTranscript.toLowerCase().trim());
                    } else if (gameState.interviewActive) {
                        dom.transcriptText.textContent = `Has dicho: "${finalTranscript.trim()}"`;
                        processTranscript(finalTranscript.toLowerCase().trim());
                    }
                }
            };
            
            recognition.onend = () => {
                if ((gameState.mode === 'identification' && !gameState.authenticated) || (gameState.mode === 'interrogation' && gameState.interviewActive)) {
                    try { recognition.start(); } catch(e) { /* Evita errores si se detiene manualmente */ }
                }
            };
            
            recognition.onerror = (event) => {
                let errorMsg = "Error de micrófono. Refresca la página.";
                if (event.error === 'not-allowed') {
                    errorMsg = "Permiso de micrófono denegado. Habilítalo en los ajustes de tu navegador.";
                }
                 if (gameState.mode === 'identification') {
                    dom.authStatus.textContent = errorMsg;
                    dom.startAuthBtn.disabled = false;
                    dom.startAuthBtn.textContent = "COMENZAR IDENTIFICACIÓN";
                } else {
                    dom.statusText.textContent = errorMsg;
                }
            };
        }

        function processIdentification(transcript) {
            const hasAgent = transcript.includes('agente');
            const hasPresent = transcript.includes('presente');
            const hasCode = transcript.includes('código');

            if (hasAgent && hasPresent && hasCode) {
                gameState.authenticated = true;
                recognition.stop();
                dom.authStatus.textContent = "IDENTIFICACIÓN VÁLIDA. ACCESO CONCEDIDO.";
                const welcomeMessage = "Bienvenido, agente. Su misión es interrogar a los siguientes candidatos. Proceda.";
                speak(welcomeMessage, 'female', () => {
                    dom.identificationScreen.style.display = 'none';
                    dom.gameContainer.classList.remove('hidden');
                    startInterrogationMode();
                });
            } else {
                dom.authStatus.textContent = "PROTOCOLO INCORRECTO. INTÉNTELO DE NUEVO.";
                speak("Protocolo de identificación incorrecto. Vuelve a intentarlo.", 'female');
            }
        }

        function startInterrogationMode() {
            gameState.mode = 'interrogation';
            Object.keys(CHARACTERS_DATA).forEach(charId => {
                const char = CHARACTERS_DATA[charId];
                const card = document.createElement('div');
                card.className = 'character-card';
                card.id = charId;
                card.innerHTML = `<img src="${char.img}" alt="${char.codename}"><span class="character-codename">${char.codename}</span>`;
                card.onclick = () => selectCharacter(charId);
                dom.charactersContainer.appendChild(card);
            });
            dom.recordBtn.onclick = toggleInterview;
        }

        function selectCharacter(charId) {
            if (gameState.interviewActive) return;
            gameState.selectedCharId = charId;
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(charId).classList.add('selected');
            clearDossier();
            dom.dossierFields.codename.textContent = CHARACTERS_DATA[charId].codename;
            dom.dossierFields.codename.classList.add('filled');
            
            const intro = `Agente ${CHARACTERS_DATA[charId].codename} presentándose. Estoy listo para el interrogatorio.`;
            dom.statusText.textContent = "Presiona 'Iniciar' para comenzar.";
            speak(intro, CHARACTERS_DATA[charId].gender);
        }

        function clearDossier() { Object.values(dom.dossierFields).forEach(field => { field.textContent = ''; field.classList.remove('filled'); }); }

        function toggleInterview() {
            if (!gameState.selectedCharId) {
                dom.statusText.textContent = "¡Primero debes seleccionar un agente!";
                return;
            }
            gameState.interviewActive = !gameState.interviewActive;
            if (gameState.interviewActive) {
                dom.recordBtn.textContent = "Terminar Interrogatorio";
                dom.recordBtn.classList.add('listening');
                dom.statusText.textContent = "Micrófono activado. ¡Pregunta!";
                recognition.start();
            } else {
                dom.recordBtn.textContent = "Iniciar Interrogatorio";
                dom.recordBtn.classList.remove('listening');
                dom.statusText.textContent = "Interrogatorio terminado.";
                recognition.stop();
                synth.cancel();
            }
        }
        
        function processTranscript(transcript) {
            const character = CHARACTERS_DATA[gameState.selectedCharId];
            
            for (const field in KEYWORD_MAP) {
                if (KEYWORD_MAP[field].some(keyword => transcript.includes(keyword))) {
                    const value = character[field];
                    const response = character.responses[field];
                    
                    if (dom.dossierFields[field].classList.contains('filled')) {
                        speak(`Ya te he dado esa información. Pregúntame otra cosa.`, character.gender);
                        return;
                    }
                    
                    fillDossierField(field, value.toString());
                    const followUpPrompt = () => {
                        if (isDossierComplete()) {
                            speak("Expediente completo. Excelente trabajo, agente.", character.gender);
                            toggleInterview();
                        } else {
                            speak("¿Cuál es tu siguiente pregunta?", character.gender);
                        }
                    };
                    speak(response, character.gender, followUpPrompt);
                    return;
                }
            }
            speak("No entendí la pregunta. ¿Puedes reformularla?", character.gender);
        }
        
        function fillDossierField(field, value) {
            const fieldEl = dom.dossierFields[field];
            if (fieldEl.classList.contains('filled')) return;
            fieldEl.textContent = value;
            fieldEl.classList.add('filled');
            dom.statusText.textContent = `Dato confirmado: ${field.toUpperCase()}`;
        }
        
        function isDossierComplete() {
            return Object.keys(dom.dossierFields).every(field => field === 'codename' || dom.dossierFields[field].classList.contains('filled'));
        }

        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
